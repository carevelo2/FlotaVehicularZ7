{% extends 'formplantilla/index_master.html' %} 
{% block content %}

<div class="wrapper">
  
 
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-6">

            <div class="card card-danger">
              <div class="card-header">
                <h3 class="card-title">Crear Persona</h3>
              </div>
              <div class="card-body">
                <form action="" method="POST" enctype="multipart/form-data">
                  {% csrf_token %}
                  
                    <!-- Identificación -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                            </div>
                            <input type="number" class="form-control" name="identificacion" id="identificacion" placeholder="Identificación" required min='0' max='9999999999' pattern="\d*" />
                        </div>
                        <small id="feedback"></small>
                    </div>

                    <!-- Nombres -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-solid fa-people-arrows"></i></span>
                            </div>
                            <input type="text" class="form-control" name="nombres" placeholder="Nombres" required />
                        </div>
                    </div>
                  
                    <!-- Apellidos -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-solid fa-people-arrows"></i></span>
                            </div>
                            <input type="text" class="form-control" name="apellidos" placeholder="Apellidos" required />
                        </div>
                    </div>

                    <!-- Contraseña -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                            </div>
                            <select 
                            name="usuario" 
                            id="usuario" 
                            class="form-control" 
                            required="">
                            <option >Usuario</option>
                            {% for usuario in usuarios %}
                                <option value="{{ usuario.id }}">{{ usuario.username }}</option>
                            {% endfor %}
                        </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                            </div>
                            <select 
                            name="rol" 
                            id="rol" 
                            class="form-control" 
                            required="">
                            <option >Rol</option>
                            {% for rol in groups %}
                                <option value="{{ rol.id }}">{{ rol.name }}</option>
                            {% endfor %}
                        </select>
                        </div>
                    </div>

                    <!-- Dirección -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" name="direccion" placeholder="Dirección" required />
                        </div>
                    </div>

                    <!-- Fecha de Nacimiento -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            </div>
                            <input type="date" class="form-control" name="fecha_nacimiento" title="Fecha de Nacimiento" placeholder="Fecha de Nacimiento" required />
                        </div>
                    </div>
                    
                    <!-- Tipo de Sangre -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-solid fa-eye-dropper"></i></span>
                            </div>
                      <select
                        class="form-control has-feedback-left"
                        name="tiposangre"
                        id="tiposangre"
                        required=""
                      >
                        <option >Tipo de Sangre</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                      </select>
                    </div>
                    </div>

                    <!-- Ciudad de Nacimiento -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-city"></i></span>
                            </div>
                            <input type="text" class="form-control" name="ciudad_nacimiento" placeholder="Ciudad de Nacimiento" required />
                        </div>
                    </div>

                    <!-- Número de Celular -->
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            </div>
                            <input type="number" class="form-control" name="numero_celular" placeholder="Número de Celular" required />
                        </div>
                    </div>
                     <!-- Contraseña -->
                     <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                            </div>
                            <select 
                            name="rango" 
                            id="rango" 
                            class="form-control" 
                            required="">
                            <option >Rango</option>
                            {% for rango in rangos %}
                                <option value="{{ rango.id }}">{{ rango.rangopersona }}</option>
                            {% endfor %}
                        </select>
                        </div>
                    </div>
                    <!-- Dependencia -->
                    
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                            </div>
                            <select 
                            name="dependencia" 
                            id="dependencia" 
                            class="form-control" 
                            required="">
                            <option >Dependencia</option>
                            {% for dependencia in dependencias %}
                                <option value="{{ dependencia.id }}">{{ dependencia.parroquia }}</option>
                            {% endfor %}
                        </select>
                        </div>
                    </div>

                    {% comment %} <!-- Otros campos similares -->
                    <!-- Subir documento para firma -->
                    <div class="form-group">
                        <label for="documentoFirma">Documento para Firma</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-file"></i></span>
                            </div>
                            <input type="file" class="form-control" name="firma" id="firma" accept=".jpg, .jpeg, .png, .pdf" required />
                        </div>
                    </div>
                    
                    <!-- Contraseña para la firma -->
                    <div class="form-group">
                        <label for="contrasenaFirma">Contraseña para Firma</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            </div>
                            <input type="password" class="form-control" name="contrasena_firma" id="contrasena_firma" placeholder="Contraseña" required />
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" autocomplete="new-password" onclick="togglePasswordVisibility('contrasena_firma')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        function togglePasswordVisibility(fieldId) {
                            var passwordField = document.getElementById(fieldId);
                            if (passwordField.type === "password") {
                                passwordField.type = "text";
                            } else {
                                passwordField.type = "password";
                            }
                        }
                    </script> {% endcomment %}
                    
                    <div class="form-group">
                        <div class="input-group">
                            <button type="submit" class="btn btn-success">Crear Persona</button>
                            <a href="{% url 'formulario_persona' %}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </div>
                </form>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->

          </div>
          <!-- /.col (right) -->
        </div>
       
      </div>
      <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <script>
    function verificarCedula(cedula) {
        if (typeof(cedula) == 'string' && cedula.length == 10 && /^\d+$/.test(cedula)) {
            var digitos = cedula.split('').map(Number);
            var codigo_provincia = digitos[0] * 10 + digitos[1];

            if (codigo_provincia >= 1 && (codigo_provincia <= 24 || codigo_provincia == 30)) {
                var tercer_digito = digitos[2];

                // Validar tercer dígito
                if (tercer_digito < 6) {
                    var digito_verificador = digitos.pop();

                    var digito_calculado = digitos.reduce(
                        function (valorPrevio, valorActual, indice) {
                            return valorPrevio - (valorActual * (2 - indice % 2)) % 9 - (valorActual == 9) * 9;
                        }, 1000) % 10;

                    return digito_calculado === digito_verificador;
                }
            }
        }
        return false;
    }

    document.getElementById('identificacion').addEventListener('input', function () {
        var inputCedula = this.value;
        var feedback = document.getElementById('feedback');

        if (verificarCedula(inputCedula)) {
            feedback.textContent = 'La cédula es válida.';
            feedback.style.color = 'green';
        } else {
            feedback.textContent = 'La cédula no es válida. Por favor, ingrese un número de cédula válido.';
            feedback.style.color = 'red';
        }
    });

    document.getElementById('identificacion').addEventListener('keypress', function (event) {
        var charCode = event.which ? event.which : event.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            event.preventDefault();
        }
    });
</script>

{% endblock %}